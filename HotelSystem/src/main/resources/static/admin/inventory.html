<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>库存管理 - 民宿管理系统</title>
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .dashboard-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin: 20px;
        }
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }
        .sidebar h3 {
            margin-bottom: 20px;
            color: #667eea;
        }
        .sidebar a {
            display: block;
            padding: 12px;
            margin-bottom: 10px;
            text-decoration: none;
            color: #333;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .sidebar a:hover,
        .sidebar a.active {
            background: #667eea;
            color: white;
        }
        .main-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .action-bar {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .low-stock {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>民宿管理系统 - 管理后台</h1>
            <div class="nav-links">
                <a href="http://localhost:8081/admin/dashboard.html">返回首页</a>
                <a href="#" onclick="auth.logout(); return false;">退出</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="sidebar">
            <h3>菜单</h3>
            <a href="http://localhost:8081/admin/dashboard.html">仪表盘</a>
            <a href="http://localhost:8081/admin/reservations.html" id="reservationsMenuLink">预订管理</a>
            <a href="http://localhost:8081/admin/room-status.html" id="roomStatusMenuLink">房态管理</a>
            <a href="http://localhost:8081/admin/rooms.html" id="roomsMenuLink">房间管理</a>
            <a href="http://localhost:8081/admin/guests.html" id="guestsMenuLink">宾客管理</a>
            <a href="http://localhost:8081/admin/inventory.html" class="active">库存管理</a>
            <a href="http://localhost:8081/admin/statistics.html" id="statisticsMenuLink">统计报表</a>
            <a href="http://localhost:8081/admin/settings.html" id="settingsMenuLink">规则设置</a>
            <a href="http://localhost:8081/admin/users.html" id="usersMenuLink" style="display:none;">员工管理</a>
        </div>

        <div class="main-content">
            <div class="action-bar">
                <h2 style="margin: 0;">库存管理</h2>
                <button class="btn btn-primary" onclick="openAddInventoryModal()">添加消耗品</button>
            </div>
            <div id="inventoryContainer">
                <div class="loading">加载中...</div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑库存模态框 -->
    <div id="inventoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="inventoryModalTitle">添加消耗品</h2>
                <button class="btn btn-secondary" onclick="closeInventoryModal()">关闭</button>
            </div>
            <form id="inventoryForm">
                <input type="hidden" id="inventoryId">
                <div class="form-group">
                    <label>物品名称 <span style="color:red;">*</span></label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label>分类</label>
                    <select id="category">
                        <option value="布草">布草</option>
                        <option value="洗浴品">洗浴品</option>
                        <option value="饮品">饮品</option>
                        <option value="清洁用品">清洁用品</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>当前数量 <span style="color:red;">*</span></label>
                    <input type="number" id="currentQuantity" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>安全库存阈值 <span style="color:red;">*</span></label>
                    <input type="number" id="safetyThreshold" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>单位成本 <span style="color:red;">*</span></label>
                    <input type="number" id="unitCost" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>单位</label>
                    <input type="text" id="unit" placeholder="如：条、瓶、包">
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <textarea id="description" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
                    <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/admin/js/api-admin.js"></script>
    <script src="/admin/js/permissions.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 检查登录状态
            if (!auth.isAuthenticated() || auth.getUserRole() === 'GUEST') {
                alert('请先登录');
                window.location.href = 'http://localhost:8081/admin/login.html';
                return;
            }
            
            // 只有经理和管理员可以访问
            const userRole = auth.getUserRole();
            if (userRole !== 'MANAGER' && userRole !== 'ADMIN') {
                alert('权限不足：只有经理和管理员可以访问库存管理');
                window.location.href = 'http://localhost:8081/admin/dashboard.html';
                return;
            }
            
            // 根据权限显示/隐藏菜单
            if (userRole === 'ADMIN') {
                const usersMenuLink = document.getElementById('usersMenuLink');
                if (usersMenuLink) {
                    usersMenuLink.style.display = 'block';
                }
            }
            
            // 加载库存列表
            loadInventory();
        });

        async function loadInventory() {
            const container = document.getElementById('inventoryContainer');
            try {
                const response = await api.get('/inventory');
                if (response && response.success && response.data) {
                    displayInventory(response.data);
                } else {
                    container.innerHTML = '<div class="alert alert-error">加载失败: ' + (response?.message || '未知错误') + '</div>';
                }
            } catch (error) {
                console.error('加载库存失败:', error);
                container.innerHTML = '<div class="alert alert-error">加载失败: ' + (error.message || '网络错误') + '</div>';
            }
        }

        function displayInventory(inventoryList) {
            const container = document.getElementById('inventoryContainer');
            if (!inventoryList || inventoryList.length === 0) {
                container.innerHTML = '<div class="alert">暂无库存记录</div>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>物品名称</th>
                            <th>分类</th>
                            <th>当前数量</th>
                            <th>安全阈值</th>
                            <th>单位成本</th>
                            <th>单位</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${inventoryList.map(item => {
                            const isLowStock = parseFloat(item.currentQuantity) < parseFloat(item.safetyThreshold);
                            return `
                                <tr class="${isLowStock ? 'low-stock' : ''}">
                                    <td>${item.itemName}</td>
                                    <td>${item.category || '-'}</td>
                                    <td>${item.currentQuantity} ${item.unit || ''}</td>
                                    <td>${item.safetyThreshold} ${item.unit || ''}</td>
                                    <td>¥${item.unitCost}</td>
                                    <td>${item.unit || '-'}</td>
                                    <td>${isLowStock ? '<span class="badge badge-warning">库存不足</span>' : '<span class="badge badge-success">正常</span>'}</td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editInventory(${item.id})">编辑</button>
                                        <button class="btn btn-info" onclick="stockIn(${item.id})">入库</button>
                                        <button class="btn btn-warning" onclick="stockOut(${item.id})">出库</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function openAddInventoryModal() {
            document.getElementById('inventoryModalTitle').textContent = '添加消耗品';
            document.getElementById('inventoryForm').reset();
            document.getElementById('inventoryId').value = '';
            document.getElementById('inventoryModal').style.display = 'flex';
        }

        function closeInventoryModal() {
            document.getElementById('inventoryModal').style.display = 'none';
        }

        async function editInventory(id) {
            try {
                const response = await api.get(`/inventory/${id}`);
                if (response && response.success && response.data) {
                    const item = response.data;
                    document.getElementById('inventoryModalTitle').textContent = '编辑消耗品';
                    document.getElementById('inventoryId').value = item.id;
                    document.getElementById('itemName').value = item.itemName || '';
                    document.getElementById('category').value = item.category || '';
                    document.getElementById('currentQuantity').value = item.currentQuantity || 0;
                    document.getElementById('safetyThreshold').value = item.safetyThreshold || 0;
                    document.getElementById('unitCost').value = item.unitCost || 0;
                    document.getElementById('unit').value = item.unit || '';
                    document.getElementById('description').value = item.description || '';
                    document.getElementById('inventoryModal').style.display = 'flex';
                } else {
                    alert('获取库存信息失败');
                }
            } catch (error) {
                console.error('获取库存信息失败:', error);
                alert('获取库存信息失败: ' + error.message);
            }
        }

        document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('inventoryId').value;
            const data = {
                itemName: document.getElementById('itemName').value,
                category: document.getElementById('category').value,
                currentQuantity: parseFloat(document.getElementById('currentQuantity').value),
                safetyThreshold: parseFloat(document.getElementById('safetyThreshold').value),
                unitCost: parseFloat(document.getElementById('unitCost').value),
                unit: document.getElementById('unit').value,
                description: document.getElementById('description').value
            };

            try {
                let response;
                if (id) {
                    response = await api.put(`/inventory/${id}`, data);
                } else {
                    response = await api.post('/inventory', data);
                }
                if (response && response.success) {
                    alert('保存成功');
                    closeInventoryModal();
                    await loadInventory();
                } else {
                    alert('保存失败: ' + (response?.message || '未知错误'));
                }
            } catch (error) {
                console.error('保存库存失败:', error);
                alert('保存失败: ' + error.message);
            }
        });

        async function stockIn(id) {
            const quantity = prompt('请输入入库数量:');
            if (!quantity || isNaN(quantity) || parseFloat(quantity) <= 0) {
                return;
            }
            const unitPrice = prompt('请输入采购单价:');
            if (!unitPrice || isNaN(unitPrice) || parseFloat(unitPrice) <= 0) {
                return;
            }
            const supplier = prompt('请输入供应商（可选）:') || '';
            const reason = prompt('请输入入库原因（可选）:') || '采购入库';

            try {
                const response = await api.post(`/inventory/${id}/stock-in`, {
                    quantity: parseFloat(quantity),
                    unitPrice: parseFloat(unitPrice),
                    supplier: supplier,
                    reason: reason
                });
                if (response && response.success) {
                    alert('入库成功');
                    await loadInventory();
                } else {
                    alert('入库失败: ' + (response?.message || '未知错误'));
                }
            } catch (error) {
                console.error('入库失败:', error);
                alert('入库失败: ' + error.message);
            }
        }

        async function stockOut(id) {
            const quantity = prompt('请输入出库数量:');
            if (!quantity || isNaN(quantity) || parseFloat(quantity) <= 0) {
                return;
            }
            const reason = prompt('请输入出库原因（可选）:') || '房务领用';
            const referenceNumber = prompt('请输入关联单号（可选）:') || '';

            try {
                const response = await api.post(`/inventory/${id}/stock-out`, {
                    quantity: parseFloat(quantity),
                    reason: reason,
                    referenceNumber: referenceNumber
                });
                if (response && response.success) {
                    alert('出库成功');
                    await loadInventory();
                } else {
                    alert('出库失败: ' + (response?.message || '未知错误'));
                }
            } catch (error) {
                console.error('出库失败:', error);
                alert('出库失败: ' + error.message);
            }
        }
    </script>
</body>
</html>

